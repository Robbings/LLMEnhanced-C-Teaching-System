from langchain_core.prompts import ChatPromptTemplate

from LLM.llm_manager import get_llm_stream

report_template = """
# ğŸ§¾ æµ‹è¯•ç”¨ä¾‹åˆ†ææŠ¥å‘Šæ¨¡æ¿

---

## ğŸ“Œ ä¸€ã€æµ‹è¯•ç”¨ä¾‹æ¦‚å†µ

| é¡¹ç›®                     | å†…å®¹                                    |
|--------------------------|----------------------------------------|
| æµ‹è¯•ç›®æ ‡æ˜ç¡®æ€§           | {{TestPurposeClarity}}                  |
| ç”¨ä¾‹è®¾è®¡å®Œæ•´æ€§           |                                        |
| æ­£å¸¸è¾“å…¥è¦†ç›–             | âœ… / âŒ                                 |
| å¼‚å¸¸è¾“å…¥è¦†ç›–             | âœ… / âŒ                                 |
| è¾¹ç•Œæ¡ä»¶è¦†ç›–             | âœ… / âŒ                                 |
| æµ‹è¯•æ–¹æ³•æ˜¯å¦æ°å½“         | {{TestingStrategy}}                     |

---

## ğŸ“Š äºŒã€æµ‹è¯•è¦†ç›–æ€§åˆ†æ

| è¦†ç›–ç±»å‹               | ç™¾åˆ†æ¯” / çŠ¶æ€            |
|----------------------|-----------------------|
| å‡½æ•°è°ƒç”¨è¦†ç›–ç‡         | {{FunctionCoverage}}%    |
| é€»è¾‘åˆ†æ”¯è¦†ç›–ç‡         | {{BranchCoverage}}%      |
| è¾¹ç•Œæ¡ä»¶è¦†ç›–           | {{BoundaryCoverage}}%    |
| å¼‚å¸¸è·¯å¾„æµ‹è¯•           | âœ… / âŒ                  |

ğŸ’¡ **æ¨¡å‹è¯„è¯­ï¼š**  
{{CoverageFeedback}}

---

## ğŸ§ª ä¸‰ã€æµ‹è¯•ç”¨ä¾‹è´¨é‡åˆ†æ

| é¡¹ç›®                     | çŠ¶æ€           |
|--------------------------|---------------|
| è¾“å…¥è¾“å‡ºæè¿°æ¸…æ™°         | âœ… / âŒ        |
| å‘½åè§„èŒƒï¼Œç»“æ„æ¸…æ™°       | âœ… / âŒ        |
| æ–­è¨€ä½¿ç”¨åˆç†             | âœ… / âŒ        |
| å­˜åœ¨å†—ä½™/ç¼ºæ¼ç”¨ä¾‹       | {{RedundancyOrMiss}} |

ğŸ’¡ **æ¨¡å‹è¯„è¯­ï¼š**  
{{TestQualityFeedback}}

---

## ğŸ§¯ å››ã€æ‰§è¡Œç»“æœä¸éªŒè¯æ•ˆæœ

| é¡¹ç›®                           | å†…å®¹                   |
|------------------------------|----------------------|
| èƒ½å¦å‘ç°ä»£ç ä¸­å­˜åœ¨çš„é—®é¢˜       | {{BugDetectability}}  |
| æ˜¯å¦å­˜åœ¨è¯¯æŠ¥/æ¼æŠ¥             | {{FalsePositiveOrNegative}} |
| æµ‹è¯•è¾“å‡ºæ—¥å¿—æ¸…æ™°æ˜äº†          | âœ… / âŒ               |

ğŸ’¡ **æ¨¡å‹è¯„è¯­ï¼š**  
{{ResultFeedback}}

---

## ğŸ”§ äº”ã€é—®é¢˜ä¸æ”¹è¿›å»ºè®®

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿°         | å»ºè®®ä¿®æ”¹æ–¹å¼        |
|----------|----------------|------------------|
| 1        | {{TestBug1}}   | {{TestFix1}}     |
| 2        | {{TestBug2}}   | {{TestFix2}}     |
| ...      | ...            | ...              |

---

## ğŸ“ˆ å…­ã€è¯„åˆ†ä¸ç­‰çº§

| é¡¹ç›®               | å¾—åˆ†         | æ»¡åˆ†  |
|------------------|------------|------|
| ç”¨ä¾‹è®¾è®¡å®Œæ•´æ€§       | {{Score1}}  | 25   |
| è¦†ç›–ç‡è¾¾æˆæƒ…å†µ       | {{Score2}}  | 25   |
| æµ‹è¯•ç”¨ä¾‹è´¨é‡         | {{Score3}}  | 20   |
| ç»“æœéªŒè¯æ•ˆæœ         | {{Score4}}  | 20   |
| æ–‡æ¡£æ¸…æ™°åº¦          | {{Score5}}  | 10   |
| **æ€»åˆ†**           | {{Total}}   | 100  |

**ç­‰çº§è¯„å®šï¼š** A / B / C / D / F

---

## ğŸ“¢ ä¸ƒã€ç»¼åˆè¯„è¯­

{{FinalTestComment}}

"""

system_prompt_test_report = """
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½æ•™å­¦è¾…åŠ©ç³»ç»Ÿï¼Œè´Ÿè´£è‡ªåŠ¨åˆ†æå­¦ç”Ÿæäº¤çš„æµ‹è¯•ç”¨ä¾‹ã€é¢˜ç›®å’Œä»£ç ï¼Œå¹¶ç”Ÿæˆæ ‡å‡†åŒ–çš„æµ‹è¯•ç”¨ä¾‹åˆ†ææŠ¥å‘Šã€‚è¯·æ ¹æ®æ¨¡æ¿ä¸­å„éƒ¨åˆ†çš„æç¤ºï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ¨¡æ¿ä¸­çš„æ ¼å¼ï¼Œå¡«å†™å®Œæ•´ã€ä¸“ä¸šã€æ¸…æ™°çš„æŠ¥å‘Šå†…å®¹ã€‚

è¦æ±‚å¦‚ä¸‹ï¼š

1. åˆ†ææµ‹è¯•ç›®æ ‡æ˜¯å¦æ˜ç¡®ï¼Œæµ‹è¯•æ–¹æ³•æ˜¯å¦é€‰æ‹©å¾—å½“ã€‚
2. åˆ¤æ–­ç”¨ä¾‹è®¾è®¡æ˜¯å¦å®Œæ•´ï¼Œæ˜¯å¦è¦†ç›–æ­£å¸¸è¾“å…¥ã€å¼‚å¸¸è¾“å…¥ã€è¾¹ç•Œæ¡ä»¶ã€‚
3. è¯„ä¼°æµ‹è¯•è¦†ç›–ç‡ï¼ŒåŒ…æ‹¬å‡½æ•°ã€åˆ†æ”¯ã€è¾¹ç•Œã€å¼‚å¸¸è·¯å¾„ã€‚
4. åˆ†ææµ‹è¯•ç”¨ä¾‹è´¨é‡ï¼ŒåŒ…æ‹¬å‘½åã€ç»“æ„ã€æ–­è¨€ã€è¾“å…¥è¾“å‡ºæè¿°æ˜¯å¦æ¸…æ™°ã€‚
5. æ£€æŸ¥æ‰§è¡Œç»“æœèƒ½å¦æœ‰æ•ˆå‘ç°ä»£ç é—®é¢˜ï¼Œæ˜¯å¦å­˜åœ¨è¯¯æŠ¥/æ¼æŠ¥ã€‚
6. åˆ—å‡ºå…·ä½“å­˜åœ¨çš„é—®é¢˜åŠæ”¹è¿›å»ºè®®ã€‚
7. æ ¹æ®å„é¡¹å¾—åˆ†ç»™å‡ºæ€»åˆ†å’Œç­‰çº§è¯„å®šã€‚
8. æœ€åç”¨è‡ªç„¶è¯­è¨€å†™ä¸€æ®µç»¼åˆè¯„è¯­ï¼Œä¿æŒå®¢è§‚ã€ä¸­ç«‹ã€é¼“åŠ±æ€§è¯­è¨€ã€‚
9. æ¨¡æ¿ä¸­çš„ âœ…/âŒ è¯·é€‰æ‹©å…¶ä¸€å¹¶ä¿ç•™ç¬¦å·ã€‚

æœ€ç»ˆè¾“å‡ºçš„å†…å®¹åº”å®Œæ•´å¡«å……æ•´ä¸ªæ¨¡æ¿ï¼Œä¸éœ€è¦è¾“å‡ºä»»ä½•å…¶ä»–è§£é‡Šæ€§æ–‡å­—ã€‚

----

ä»¥ä¸‹æ˜¯æ¨¡æ¿å†…å®¹ï¼š

"""

user_prompt_test_report = """
è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½å®Œæ•´çš„ Markdown æ ¼å¼çš„ **æµ‹è¯•ç”¨ä¾‹åˆ†ææŠ¥å‘Š**ï¼Œå†…å®¹è¦å®Œæ•´è¦†ç›–å„éƒ¨åˆ†ï¼Œå¹¶ç»“åˆé¢˜ç›®ã€å­¦ç”Ÿä»£ç å’Œæµ‹è¯•ç”¨ä¾‹è¿›è¡Œæ·±å…¥åˆ†æã€‚

---
### ğŸ“ è¾“å…¥ä¿¡æ¯

- **é¢˜ç›®æè¿°ï¼š**
{question}

- **å­¦ç”Ÿæäº¤ä»£ç ï¼š**

```c
{code}
```

- **æµ‹è¯•ç”¨ä¾‹ä»£ç ï¼š**

```c
{test_code}
```

"""

test_report_prompt_template = ChatPromptTemplate([
    ("system", system_prompt_test_report + report_template),
    ("user", user_prompt_test_report),
])

def test_report_node(state):
    """ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹åˆ†ææŠ¥å‘Š"""
    question = state["question"]
    code = state["code"]
    test_code = state["test_code"]

    # å°†ä¿¡æ¯ä¼ é€’ç»™æ¨¡æ¿
    return test_report_prompt_template.format(
        question=question,
        code=code,
        test_code=test_code
    )

def gen_test_report(state):
    """ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹åˆ†ææŠ¥å‘Š"""
    question = state["question"]
    code = state["code"]
    test_code = state["test_code"]

    # å°†ä¿¡æ¯ä¼ é€’ç»™æ¨¡æ¿
    prompt = test_report_prompt_template.format(
        question=question,
        code=code,
        test_code=test_code
    )

    llm = get_llm_stream()
    response = llm.invoke(prompt)
    return response.content

if __name__ == "__main__":
    # æµ‹è¯•ç”¨ä¾‹
    test_state = {
        "question": "è¯·å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºå›æ–‡ã€‚",
        "code": "def is_palindrome(s):\n    return s == s[::-1]",
        "test_code": "def test_is_palindrome():\n    assert is_palindrome('racecar') == True\n    assert is_palindrome('hello') == False"
    }

    report = gen_test_report(test_state)
    print(report)
