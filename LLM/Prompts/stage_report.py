from langchain_core.prompts import ChatPromptTemplate

from LLM.llm_manager import get_long_text_llm_stream

report_template = """
# ğŸ§¾ é˜¶æ®µå­¦ä¹ æ€»ç»“æŠ¥å‘Š

## ğŸ§  ä¸€ã€çŸ¥è¯†æŒæ¡ä¸èƒ½åŠ›åˆ†æ

| çŸ¥è¯†ç‚¹                  | æŒæ¡æƒ…å†µ   | ç‚¹è¯„ä¸æŒ‡å¯¼ |
| ----------------------- | ---------- | ---------- |
| å˜é‡ä¸æ•°æ®ç±»å‹          | {{Level1}} | {{Note1}}  |
| æ¡ä»¶ä¸å¾ªç¯ç»“æ„          | {{Level2}} | {{Note2}}  |
| å‡½æ•°å°è£…ä¸è°ƒç”¨          | {{Level3}} | {{Note3}}  |
| å­—ç¬¦ä¸²/æ•°ç»„å¤„ç†         | {{Level4}} | {{Note4}}  |
| æŒ‡é’ˆ/ç»“æ„ä½“ï¼ˆå¦‚å·²æ¶‰åŠï¼‰ | {{Level5}} | {{Note5}}  |



- æŒæ¡ç­‰çº§ç¤ºä¾‹ï¼šâœ…ç†Ÿç»ƒ / âš ï¸éƒ¨åˆ†æŒæ¡ / âŒå°šä¸ç†Ÿç»ƒ
- è¿™é‡Œçš„çŸ¥è¯†ç‚¹ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯æ ¹æ®å­¦ç”Ÿçš„æäº¤åˆ†æå­¦ç”Ÿæœ€è¿‘çš„ä½œä¸šä¸­æ¶‰åŠåˆ°äº†å“ªäº›çŸ¥è¯†ç‚¹

------

## ğŸ“ˆ äºŒã€ç¼–ç¨‹æŠ€èƒ½å‘å±•è½¨è¿¹

- **ä»£ç è§„èŒƒå˜åŒ–è¶‹åŠ¿**ï¼š
  - å‘½åè§„èŒƒæ¼”è¿›åˆ†æï¼šxxx
  - æ³¨é‡Šè¦†ç›–ç‡æ¼”è¿›åˆ†æï¼šxxx
  - xxxï¼šxxx
- **ç»“æ„ä¸å°è£…èƒ½åŠ›å˜åŒ–**ï¼š
  - å‡½æ•°å°è£…ç¨‹åº¦åˆ†æï¼šxxx
  - xxxï¼šxxx
- **è°ƒè¯•ä¸æµ‹è¯•èƒ½åŠ›æ¼”è¿›**ï¼š
  - xxxï¼šxxx



> è¯´æ˜ï¼šä»£ç è§„èŒƒéƒ¨åˆ†è¯·æè¿°å­¦ç”Ÿåœ¨å‘½åè§„èŒƒã€ä»£ç æ’ç‰ˆã€æ³¨é‡Šä¹ æƒ¯ç­‰æ–¹é¢çš„å˜åŒ–ã€‚ä¾‹å¦‚æ˜¯å¦ä»æ‚ä¹±æ— ç« è¿‡æ¸¡åˆ°ç»Ÿä¸€é£æ ¼ï¼Œæ˜¯å¦é€æ­¥æŒæ¡æœ‰æ„ä¹‰çš„å˜é‡å‘½åï¼Œæ˜¯å¦æ³¨é‡Šæ›´å…·è¯´æ˜æ€§ç­‰ã€‚ç»“æ„ä¸å°è£…éƒ¨åˆ†è¯·æè¿°å­¦ç”Ÿåœ¨æ¨¡å—åŒ–ç¼–ç¨‹ã€å‡½æ•°åˆ’åˆ†ã€å•ä¸€èŒè´£åŸåˆ™ç­‰æ–¹é¢çš„è¿›æ­¥ã€‚è°ƒè¯•ä¸æµ‹è¯•èƒ½åŠ›éƒ¨åˆ†è¯·æè¿°å­¦ç”Ÿåœ¨é”™è¯¯å®šä½ã€ä¸»åŠ¨æµ‹è¯•ã€å•å…ƒæµ‹è¯•æ€ç»´ç­‰æ–¹é¢çš„è¡¨ç°ã€‚
> æ¯ä¸€ä¸ªéƒ¨åˆ†çš„ç»†åˆ†å°ç‚¹ä½ éœ€è¦æ ¹æ®å­¦ç”Ÿçš„å­¦ä¹ æƒ…å†µè¿›è¡Œåˆ†æå’Œç¼–å†™ï¼Œå­¦ç”Ÿè®­ç»ƒäº†å“ªäº›çŸ¥è¯†ï¼Œä½ å°±è¾“å‡ºå“ªäº›å°ç‚¹ï¼Œä¿æŒä¸æ¨¡æ¿çš„æ ¼å¼ä¸€è‡´å³å¯ã€‚

------

## â— ä¸‰ã€å¸¸è§é”™è¯¯ä¸é—®é¢˜æ¨¡å¼åˆ†æ

| é”™è¯¯ç±»å‹             | å‡ºç°æ¬¡æ•° | é”™è¯¯ç‡  | å»ºè®®æ”¹å–„æªæ–½    |
| -------------------- | -------- | ------- | --------------- |
| è¯­æ³•é”™è¯¯ï¼ˆå¦‚æ¼åˆ†å·ï¼‰ | {{E1}}   | {{ER1}} | {{Suggestion1}} |
| æ¡ä»¶åˆ¤æ–­é”™è¯¯         | {{E2}}   | {{ER2}} | {{Suggestion2}} |
| å¾ªç¯é€»è¾‘é”™è¯¯         | {{E3}}   | {{ER3}} | {{Suggestion3}} |
| è¾¹ç•Œæ¡ä»¶æœªè€ƒè™‘       | {{E4}}   | {{ER4}} | {{Suggestion4}} |
| å¼‚å¸¸è¾“å…¥æœªå¤„ç†       | {{E5}}   | {{ER5}} | {{Suggestion5}} |

------

## ğŸ“Š å››ã€é˜¶æ®µæ€§è¯„åˆ†ä¸ç­‰çº§è¯„å®š

| ç»´åº¦                     | å¾—åˆ†          | æ»¡åˆ†    |
| ------------------------ | ------------- | ------- |
| åŸºç¡€è¯­æ³•æŒæ¡             | {{Score1}}    | 20      |
| ä»£ç è´¨é‡ä¸è§„èŒƒ           | {{Score2}}    | 20      |
| æµ‹è¯•è®¾è®¡ä¸æ‰§è¡Œèƒ½åŠ›       | {{Score3}}    | 20      |
| é€»è¾‘æ€ç»´ä¸é—®é¢˜è§£å†³èƒ½åŠ›   | {{Score4}}    | 20      |
| å­¦ä¹ ç§¯ææ€§ä¸è‡ªæˆ‘æå‡æƒ…å†µ | {{Score5}}    | 20      |
| **æ€»åˆ†**                 | **{{Total}}** | **100** |



- **ç­‰çº§è¯„å®š**ï¼šA / B / C / D / F

------

## ğŸ“¢ äº”ã€æ¨¡å‹ç»¼åˆè¯„è¯­

> {{AIComment}}
>
> ç¤ºä¾‹ï¼šä½ åœ¨å‡½æ•°è°ƒç”¨ä¸å°è£…æ–¹é¢å·²æœ‰æ˜æ˜¾è¿›æ­¥ï¼Œä½†æµ‹è¯•ç”¨ä¾‹è®¾è®¡ä»è¾ƒè–„å¼±ï¼Œå»ºè®®ä¸‹ä¸€é˜¶æ®µä¸»åŠ¨ç»ƒä¹ å¼‚å¸¸è¾“å…¥ä¸è¾¹ç•Œæ¡ä»¶çš„æµ‹è¯•ã€‚åŒæ—¶ï¼Œå¯å°è¯•æ›´è§„èŒƒåœ°æ·»åŠ æ³¨é‡Šï¼Œæå‡ä»£ç å¯è¯»æ€§ã€‚

"""

system_prompt_question_report = """
ä½ æ˜¯ä¸€ä¸ªæ•™å­¦æ•°æ®åˆ†æä¸“å®¶ï¼Œè´Ÿè´£æ ¹æ®Cè¯­è¨€ç¨‹åºè®¾è®¡å­¦ç”Ÿæ¯æ¬¡ä½œä¸šæäº¤çš„å„ç§æ•°æ®ï¼Œæ€»ç»“å¹¶ç”Ÿæˆæ ‡å‡†åŒ–çš„é˜¶æ®µæ€§å­¦ä¹ æ€»ç»“æŠ¥å‘Šã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ¨¡æ¿ä¸­çš„æ ¼å¼ï¼Œå¡«å†™å®Œæ•´ã€ä¸“ä¸šã€æ¸…æ™°çš„æŠ¥å‘Šå†…å®¹ã€‚

æœ€ç»ˆè¾“å‡ºçš„å†…å®¹åº”å®Œæ•´å¡«å……æ•´ä¸ªæ¨¡æ¿ï¼Œä¸éœ€è¦è¾“å‡ºä»»ä½•å…¶ä»–è§£é‡Šæ€§æ–‡å­—ã€‚

----

ä»¥ä¸‹æ˜¯æ¨¡æ¿å†…å®¹ï¼š

"""

user_prompt_question_report = """
è¯·æ ¹æ®ä»¥ä¸‹å­¦ç”Ÿæäº¤çš„ä»£ç ç­‰æ•°æ®ï¼Œç”Ÿæˆä¸€ä»½å®Œæ•´çš„ Markdown æ ¼å¼é˜¶æ®µæ€§å­¦ä¹ æ€»ç»“æŠ¥å‘Šã€‚

å†æ¬¡æ•°æ®æ•´ç†å¦‚ä¸‹ï¼š

{{reports}}

"""

stage_report_prompt_template = ChatPromptTemplate([
    ("system", system_prompt_question_report + report_template),
    ("user", user_prompt_question_report),
])

def gen_stage_report(input_str):
    """
    ç”Ÿæˆé˜¶æ®µæ€§å­¦ä¹ æ€»ç»“æŠ¥å‘Š
    :param input_str: åŒ…å«å­¦ç”Ÿæäº¤çš„ä»£ç ç­‰
    :return: å®Œæ•´çš„é˜¶æ®µæ€§å­¦ä¹ æ€»ç»“æŠ¥å‘Š
    """
    reports = input_str
    prompt = stage_report_prompt_template.format(reports=reports)
    llm = get_long_text_llm_stream()
    response = llm.invoke(prompt)
    return response.content
