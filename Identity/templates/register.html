{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <title>ç³»ç»Ÿç™»å½•</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{% static 'login/css/style.css' %}">

    <style>
      #signup-form {
        display: none;
      }
      .alert {
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
      }
      .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .captcha-container {
        position: relative;
      }
      .captcha-refresh {
        cursor: pointer;
        position: absolute;
        right: 5px;
        top: 5px;
        background: rgba(0,0,0,0.7);
        color: white;
        border-radius: 3px;
        padding: 2px 5px;
        font-size: 12px;
      }
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <section class="ftco-section">
       <div class="container">
          <div class="row justify-content-center">
             <div class="col-md-12 col-lg-10">
                <div class="wrap d-md-flex">
                   <div class="text-wrap p-4 p-lg-5 text-center d-flex align-items-center order-md-last">
                      <div class="text w-100">
                         <h2>æ¬¢è¿ä½¿ç”¨åŸºäºå¤§æ¨¡å‹çš„Cè¯­è¨€è¾…åŠ©æ•™å­¦ç³»ç»Ÿ</h2>
                         <p id="login-text">è¿˜æ²¡æœ‰ä¸€ä¸ªè´¦å·?</p>
                         <p id="signup-text" style="display: none;">å·²æœ‰è´¦å·?</p>
                         <a href="#" class="btn btn-white btn-outline-white" id="toggle-form">Sign Up</a>
                      </div>
                   </div>
                   <div class="login-wrap p-4 p-lg-5">
                     <div class="d-flex">
                        <div class="w-100">
                           <h3 class="mb-4" id="form-title">ç™»å½•</h3>
                        </div>
                        <div class="w-100">
                           <p class="social-media d-flex justify-content-end">
                              <a href="#" class="social-icon d-flex align-items-center justify-content-center active" id="student-role" data-role="user" title="å­¦ç”Ÿ">
                                <span class="fa fa-graduation-cap"></span>
                              </a>
                              <a href="#" class="social-icon d-flex align-items-center justify-content-center" id="teacher-role" data-role="teacher" title="æ•™å¸ˆ">
                                <span class="fa fa-user-circle"></span>
                              </a>
                           </p>
                        </div>
                     </div>

                     <!-- Alert Messages -->
                     <div id="alert-container"></div>

                     <!-- Login Form -->
                     <form action="#" class="signin-form" id="login-form">
                        <div class="form-group mb-3">
                           <label class="label" for="login-email">é‚®ç®±</label>
                           <input type="email" class="form-control" id="login-email" name="email" placeholder="é‚®ç®±" required>
                        </div>
                        <div class="form-group mb-3">
                            <label class="label" for="login-password">å¯†ç </label>
                            <input type="password" class="form-control" id="login-password" name="password" placeholder="å¯†ç " required>
                        </div>

                        <div class="form-group mb-3">
                            <label class="label" for="login-captcha">éªŒè¯ç </label>
                            <input type="text" class="form-control" id="login-captcha" name="captcha" placeholder="éªŒè¯ç " required>
                        </div>
                        <div class="form-group mb-3">
                            <div class="captcha-container">
                                <img id="login-captcha-img" src="" alt="éªŒè¯ç " class="img-fluid d-block mx-auto" style="width: 120px; height: auto; cursor: pointer;">
                                <span class="captcha-refresh" title="ç‚¹å‡»åˆ·æ–°">ğŸ”„</span>
                            </div>
                            <input type="hidden" id="login-captcha-hashkey" name="captcha_hashkey">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="form-control btn btn-primary submit px-3" id="login-btn">ç™»å½•</button>
                        </div>
                        <div class="form-group d-md-flex">
                            <div class="w-50 text-left">
                                <label class="checkbox-wrap checkbox-primary mb-0">è®°ä½å¯†ç 
                                    <input type="checkbox" id="remember-me">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <div class="w-50 text-md-right">
                                <a href="#">å¿˜è®°å¯†ç </a>
                            </div>
                        </div>
                     </form>

                     <!-- Registration Form -->
                     <form action="#" class="signin-form" id="signup-form">
                        <div class="form-group mb-3">
                           <label class="label" for="signup-username">ç”¨æˆ·å</label>
                           <input type="text" class="form-control" id="signup-username" name="username" placeholder="ç”¨æˆ·å" required>
                        </div>
                        <div class="form-group mb-3">
                           <label class="label" for="signup-email">é‚®ç®±</label>
                           <input type="email" class="form-control" id="signup-email" name="email" placeholder="é‚®ç®±" required>
                        </div>
                        <div class="form-group mb-3">
                            <label class="label" for="signup-password">å¯†ç </label>
                            <input type="password" class="form-control" id="signup-password" name="password" placeholder="å¯†ç " required>
                        </div>
                        <div class="form-group mb-3">
                            <label class="label" for="signup-confirm-password">ç¡®è®¤å¯†ç </label>
                            <input type="password" class="form-control" id="signup-confirm-password" name="confirm_password" placeholder="ç¡®è®¤å¯†ç " required>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="form-control btn btn-primary submit px-3" id="signup-btn">æ³¨å†Œ</button>
                        </div>
                     </form>
                   </div>
                </div>
             </div>
          </div>
       </div>
    </section>

    <script src="{% static 'login/js/jquery.min.js' %}"></script>
    <script src="{% static 'login/js/popper.js' %}"></script>
    <script src="{% static 'login/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'login/js/main.js' %}"></script>

    <script>
      $(document).ready(function() {
        // CSRF Token setup
        const csrftoken = $('meta[name=csrf-token]').attr('content');

        // è·å–CSRF tokençš„å‡½æ•°
        function getCSRFToken() {
            return $('input[name=csrfmiddlewaretoken]').val() || csrftoken;
        }
        // è§’è‰²é€‰æ‹©åŠŸèƒ½
        let currentRole = 'user'; // é»˜è®¤ä¸ºå­¦ç”Ÿ

        // è§’è‰²åˆ‡æ¢ç‚¹å‡»äº‹ä»¶
        $('.social-icon').click(function(e) {
            e.preventDefault();

            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            $('.social-icon').removeClass('active');

            // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å½“å‰ç‚¹å‡»çš„å›¾æ ‡
            $(this).addClass('active');

            // æ›´æ–°å½“å‰è§’è‰²
            currentRole = $(this).data('role');
        });

        // è·å–å½“å‰é€‰ä¸­çš„è§’è‰²
        function getCurrentRole() {
            return currentRole;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'danger') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('#alert-container').html(alertHtml);

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                $('#alert-container .alert').fadeOut();
            }, 3000);
        }

        // æ¸…é™¤æ¶ˆæ¯
        function clearMessages() {
            $('#alert-container').empty();
        }

        // åˆ·æ–°éªŒè¯ç 
        function refreshCaptcha() {
            $.ajax({
                url: '/user/refresh_captcha',
                type: 'GET',
                success: function(response) {
                    $('#login-captcha-img').attr('src', response.image_url);
                    $('#login-captcha-hashkey').val(response.hashkey);
                },
                error: function() {
                    showMessage('éªŒè¯ç åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶è·å–éªŒè¯ç 
        refreshCaptcha();

        // ç‚¹å‡»éªŒè¯ç å›¾ç‰‡åˆ·æ–°
        $(document).on('click', '#login-captcha-img, .captcha-refresh', function() {
            refreshCaptcha();
        });

        // è¡¨å•åˆ‡æ¢
        $("#toggle-form").click(function(e) {
          e.preventDefault();
          clearMessages();

          if ($("#login-form").is(":visible")) {
            // Switch to signup form
            $("#login-form").hide();
            $("#signup-form").show();
            $("#form-title").text("æ³¨å†Œ");
            $("#toggle-form").text("Log In");
            $("#login-text").hide();
            $("#signup-text").show();
          } else {
            // Switch to login form
            $("#signup-form").hide();
            $("#login-form").show();
            $("#form-title").text("ç™»å½•");
            $("#toggle-form").text("Sign Up");
            $("#signup-text").hide();
            $("#login-text").show();
            // åˆ‡æ¢åˆ°ç™»å½•è¡¨å•æ—¶åˆ·æ–°éªŒè¯ç 
            refreshCaptcha();
          }
        });

        // ç™»å½•è¡¨å•æäº¤
        $('#login-form').submit(function(e) {
            e.preventDefault();

            const $form = $(this);
            const $submitBtn = $('#login-btn');
            const originalBtnText = $submitBtn.text();

            // éªŒè¯è¡¨å•
            const email = $('#login-email').val().trim();
            const password = $('#login-password').val();
            const captcha = $('#login-captcha').val().trim();
            const role = getCurrentRole(); // ä½¿ç”¨è§’è‰²é€‰æ‹©åŠŸèƒ½è·å–è§’è‰²
            const captchaHashkey = $('#login-captcha-hashkey').val();

            if (!email || !password || !captcha || !role) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            if (!captchaHashkey) {
                showMessage('éªŒè¯ç æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                refreshCaptcha();
                return;
            }

            // ç¦ç”¨æäº¤æŒ‰é’®
            $submitBtn.prop('disabled', true).text('ç™»å½•ä¸­...');
            $form.addClass('loading');
            clearMessages();

            // æäº¤æ•°æ®
            $.ajax({
                url: '/user/login',
                type: 'POST',
                data: {
                    email: email,
                    password: password,
                    captchaCode: captcha,
                    captchaHashkey: captchaHashkey,
                    role: role,
                    csrfmiddlewaretoken: getCSRFToken()
                },
                success: function(response) {
                    if (response.code === 200) {
                        showMessage(response.message || 'ç™»å½•æˆåŠŸ', 'success');
                        // å»¶è¿Ÿè·³è½¬
                        setTimeout(() => {
                            window.location.href = '/analysis/problems';
                        }, 1000);
                    } else {
                        showMessage(response.message || 'ç™»å½•å¤±è´¥');
                        //å¦‚æœå·²ç»ç™»å½•ï¼Œåˆ™è·³è½¬åˆ°é—®é¢˜åˆ†æé¡µé¢
                        if (response.message && response.message.includes('å·²ç»ç™»å½•')) {
                            // å»¶è¿Ÿè·³è½¬
                            setTimeout(() => {
                                window.location.href = '/analysis/problems';
                            }, 1000);
                        }
                        // å¦‚æœè¿”å›äº†æ–°çš„éªŒè¯ç ï¼Œæ›´æ–°éªŒè¯ç 
                        if (response.captcha) {
                            $('#login-captcha-img').attr('src', response.captcha.image_url);
                            $('#login-captcha-hashkey').val(response.captcha.hashkey);
                            $('#login-captcha').val('');
                        } else {
                            refreshCaptcha();
                        }
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    showMessage(errorMessage);
                    refreshCaptcha();
                },
                complete: function() {
                    // æ¢å¤æäº¤æŒ‰é’®
                    $submitBtn.prop('disabled', false).text(originalBtnText);
                    $form.removeClass('loading');
                }
            });
        });

        // æ³¨å†Œè¡¨å•æäº¤
        $('#signup-form').submit(function(e) {
            e.preventDefault();

            const $form = $(this);
            const $submitBtn = $('#signup-btn');
            const originalBtnText = $submitBtn.text();

            // éªŒè¯è¡¨å•
            const username = $('#signup-username').val().trim();
            const email = $('#signup-email').val().trim();
            const password = $('#signup-password').val();
            const confirmPassword = $('#signup-confirm-password').val();
            const role = getCurrentRole(); // ä½¿ç”¨è§’è‰²é€‰æ‹©åŠŸèƒ½è·å–è§’è‰²

            if (!username || !email || !password || !confirmPassword) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }

            if (password.length < 6) {
                showMessage('å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }

            // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }

            // ç¦ç”¨æäº¤æŒ‰é’®
            $submitBtn.prop('disabled', true).text('æ³¨å†Œä¸­...');
            $form.addClass('loading');
            clearMessages();

            // æäº¤æ•°æ®
            $.ajax({
                url: '/user/register',
                type: 'POST',
                data: {
                    username: username,
                    email: email,
                    password: password,
                    role: role,
                    csrfmiddlewaretoken: getCSRFToken()
                },
                success: function(response) {
                    if (response.code === 200) {
                        showMessage(response.message || 'æ³¨å†ŒæˆåŠŸï¼Œè¯·æŸ¥æ”¶é‚®ä»¶æ¿€æ´»è´¦æˆ·', 'success');
                        // 3ç§’ååˆ‡æ¢åˆ°ç™»å½•è¡¨å•
                        setTimeout(() => {
                            $('#toggle-form').click();
                            // æ¸…ç©ºæ³¨å†Œè¡¨å•
                            $form[0].reset();
                        }, 2000);
                    } else {
                        showMessage(response.message || 'æ³¨å†Œå¤±è´¥');
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 400) {
                        errorMessage = 'è¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®';
                    }
                    showMessage(errorMessage);
                },
                complete: function() {
                    // æ¢å¤æäº¤æŒ‰é’®
                    $submitBtn.prop('disabled', false).text(originalBtnText);
                    $form.removeClass('loading');
                }
            });
        });

        // è®°ä½å¯†ç åŠŸèƒ½ï¼ˆç®€å•å®ç°ï¼Œä»…ä¿å­˜é‚®ç®±ï¼‰
        $('#remember-me').change(function() {
            if ($(this).is(':checked')) {
                const email = $('#login-email').val();
                if (email) {
                    localStorage.setItem('remembered_email', email);
                }
            } else {
                localStorage.removeItem('remembered_email');
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ¢å¤è®°ä½çš„é‚®ç®±
        const rememberedEmail = localStorage.getItem('remembered_email');
        if (rememberedEmail) {
            $('#login-email').val(rememberedEmail);
            $('#remember-me').prop('checked', true);
        }

        // å½“é‚®ç®±è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œå¦‚æœå‹¾é€‰äº†è®°ä½å¯†ç ï¼Œåˆ™ä¿å­˜é‚®ç®±
        $('#login-email').blur(function() {
            if ($('#remember-me').is(':checked')) {
                const email = $(this).val();
                if (email) {
                    localStorage.setItem('remembered_email', email);
                }
            }
        });
      });
    </script>
  </body>
</html>